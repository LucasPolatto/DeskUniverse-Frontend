@page "/Home"
@inject NavigationManager Navigation
@inject HttpClient Http
@using DeskUniverse_Frontend.Models
@inject UserService UserService
@inject CharacterService CharacterService

<!DOCTYPE html>
<html lang="en">

    <head>
        <title>Document</title>
        <link rel="stylesheet" href="css/style.css">
    </head>
    <body>
        @if (UserService.Logado == true)
        {
            <div class="body">

                <section class="container">
                    <div class="row">

                        <!-- Card das campanhas -->
                        <div class="card col" style="width: 18rem;">
                            <a data-bs-toggle="modal" data-bs-target="#Campaigns">
                                <img src="/img/skill.jpg" class="" alt="...">
                                <div class="card-img-overlay">
                                    <h5 class="card-title">Campanhas</h5>
                                    <p class="card-text">Gerencie suas campanhas</p>
                                </div>
                            </a>
                        </div>

                        <!-- Modal de exibição resumida de campanhas-->
                        <div class="modal fade" id="Campaigns" tabindex="-1" aria-labelledby="CampaignsLabel"
                            aria-hidden="true">
                            <div class="modal-dialog modal-xl ">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h1 class="modal-title fs-5" id="CampaignsLabel">Campanhas</h1>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th scope="col">Mestre</th>
                                                    <th scope="col">Nome</th>
                                                    <th scope="col">Data da sessão</th>
                                                    <th scope="col">Hora da sessão</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var _campaign in campaigns)
                                                {
                                                    @if (_campaign.UserId == UserService.Id)
                                                    {
                                                        <tr>
                                                            <td>@IdForUserName(_campaign.UserId)</td>
                                                            <td>@_campaign.Name</td>
                                                            <td>@_campaign.SessionDate</td>
                                                            <td>@_campaign.SessionHour</td>
                                                            <td>
                                                                <button class="btn btn-primary">Visualizar</button>

                                                                <!-- Botão de Delete de campanha -->
                                                                <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#CampaignDelete" @onclick="(() => SaveIdForDelete(_campaign.Id))">Deletar</button>
                                                            </td>
                                                        </tr>
                                                    }
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modal de exibição de confirmação de Delete de campanha-->
                        <div class="modal fade" id="CampaignDelete" tabindex="-1" aria-labelledby="CampaignDeleteLabel"
                            aria-hidden="true">
                            <div class="modal-dialog modal-xl ">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h1 class="modal-title fs-5" id="CampaignDeleteLabel">Deletar campanha?</h1>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <h5> Uma campanha deletada não pode ser restaurada! </h5>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#Campaigns">Cancelar</button>
                                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" @onclick="(() => DeleteCampaign(IdForDelete))">Confirmar</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Card dos personagens -->
                        <div class="card col" style="width: 18rem;">
                            <a data-bs-toggle="modal" data-bs-target="#Characters">
                                <img src="/img/personagem.jpg" class="" alt="...">
                                <div class="card-img-overlay">
                                    <h5 class="card-title">personagens</h5>
                                    <p class="card-text">Gerencie seus personagens</p>
                                </div>
                            </a>
                        </div>

                        <!-- Modal de exibição resumida de personagens-->
                        <div class="modal fade" id="Characters" tabindex="-1" aria-labelledby="CharactersLabel"
                            aria-hidden="true">
                            <div class="modal-dialog modal-xl ">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h1 class="modal-title fs-5" id="CharactersLabel">Personagens</h1>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th scope="col">Id</th>
                                                    <th scope="col">Nome</th>
                                                    <th scope="col">Gênero</th>
                                                    <th scope="col">Raça</th>
                                                    <th scope="col">Classe</th>
                                                    <th scope="col">Nível</th>
                                                    <th scope="col">Campanha</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var _character in characters)
                                                {
                                                    @if (_character.UserId == UserService.Id)
                                                    {
                                                        <tr>
                                                            <td>@_character.Id</td>
                                                            <td>@_character.Name</td>
                                                            <td>@_character.Gender</td>
                                                            <td>@_character.Race</td>
                                                            <td>@_character.Class</td>
                                                            <td>@_character.Level</td>
                                                            <td>@IdForCampaignName(_character.CampaignId)</td>
                                                            <td>
                                                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#CharacterView" @onclick="(() => CharacterService.CharacterSave(_character))">Visualizar</button>

                                                                <!-- Botão de Delete de personagem -->
                                                                <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#CharacterDelete" @onclick="(() => SaveIdForDelete(_character.Id))">Deletar</button>
                                                            </td>
                                                        </tr>
                                                    }
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modal de exibição de personagens-->
                        <div class="modal fade" id="CharacterView" tabindex="-1" aria-labelledby="CharacterViewLabel"
                            aria-hidden="true">
                            <div class="modal-dialog modal-xl ">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h1 class="modal-title fs-5" id="CharacterViewLabel">Ficha de Personagem</h1>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th scope="col">Jogador</th>
                                                    <td style="width: 15%;">@IdForUserName(CharacterService.CharacterData.UserId)</td>
                                                    <th scope="col" style="width: 10%;">Campanha</th>
                                                    <td>@IdForCampaignName(CharacterService.CharacterData.CampaignId)</td>
                                                </tr>
                                                <br><br>
                                                <tr>
                                                    <th scope="col" colspan="4" style="text-align: center;">IDENTIFICAÇÃO DO PERSONAGEM</th>
                                                </tr>
                                                <br>
                                                <tr>
                                                    <th scope="col">Nome</th>
                                                    <td>@CharacterService.CharacterData.Name</td>
                                                    <th scope="col">Raça</th>
                                                    <td>@CharacterService.CharacterData.Race</td>
                                                </tr>
                                                <tr>
                                                    <th scope="col">Gênero</th>
                                                    <td>@CharacterService.CharacterData.Gender</td>
                                                    <th scope="col">Idade</th>
                                                    <td>@CharacterService.CharacterData.Age</td>
                                                </tr>
                                                <tr>
                                                    <th scope="col">Classe</th>
                                                    <td>@CharacterService.CharacterData.Class</td>
                                                    <th scope="col">Nível</th>
                                                    <td>@CharacterService.CharacterData.Level</td>
                                                </tr>
                                                <br>
                                                <tr>
                                                    <th scope="col">Descrição</th>
                                                    <td colspan="3">@CharacterService.CharacterData.Description</td>
                                                </tr>
                                                <br>
                                                <tr>
                                                    <th scope="col">História</th>
                                                    <td colspan="3">@CharacterService.CharacterData.History</td>
                                                </tr>
                                                <br><br>
                                                <tr>
                                                    <th scope="col" colspan="4" style="text-align: center;">ESTATÍSTICAS</th>
                                                </tr>
                                                <tr>
                                                    <th scope="col" colspan="2" style="text-align: center;">HP / MP</th>
                                                </tr>
                                                <br>
                                                <tr>
                                                    <th scope="col">Vida</th>
                                                    <td style="text-align: center;">@CharacterService.CharacterData.Health</td>
                                                </tr>
                                                <tr>
                                                    <th scope="col">Mana</th>
                                                    <td style="text-align: center;">@CharacterService.CharacterData.Mana</td>
                                                </tr>
                                                <br><br>
                                                <tr>
                                                    <th scope="col" colspan="2" style="text-align: center;">RESISTÊNCIAS</th>
                                                </tr>
                                                <tr>
                                                    <th scope="col">Defesa Física</th>
                                                    <td style="text-align: center;">@CharacterService.CharacterData.PD</td>
                                                </tr>
                                                <tr>
                                                    <th scope="col">Defesa Mágica</th>
                                                    <td style="text-align: center;">@CharacterService.CharacterData.MD</td>
                                                </tr>
                                                <br><br>
                                                <tr>
                                                    <th scope="col" colspan="2" style="text-align: center;">STATUS</th>
                                                    <th scope="col" style="text-align: center;">MODIFICADOR</th>
                                                </tr>
                                                <tr>
                                                    <th scope="col">Força</th>
                                                    <td style="text-align: center;">@CharacterService.CharacterData.STR</td>
                                                </tr>
                                                <tr>
                                                    <th scope="col">Destreza</th>
                                                    <td style="text-align: center;">@CharacterService.CharacterData.DEX</td>
                                                </tr>
                                                <tr>
                                                    <th scope="col">Constituição</th>
                                                    <td style="text-align: center;">@CharacterService.CharacterData.CON</td>
                                                </tr>
                                                <tr>
                                                    <th scope="col">Inteligência</th>
                                                    <td style="text-align: center;">@CharacterService.CharacterData.INT</td>
                                                </tr>
                                                <tr>
                                                    <th scope="col">Sabedoria</th>
                                                    <td style="text-align: center;">@CharacterService.CharacterData.WIS</td>
                                                </tr>
                                                <tr>
                                                    <th scope="col">Vontade</th>
                                                    <td style="text-align: center;">@CharacterService.CharacterData.WIL</td>
                                                </tr>
                                            </thead>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modal de exibição de confirmação de Delete de personagem-->
                        <div class="modal fade" id="CharacterDelete" tabindex="-1" aria-labelledby="CharacterDeleteLabel"
                            aria-hidden="true">
                            <div class="modal-dialog modal-xl ">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h1 class="modal-title fs-5" id="CharacterDeleteLabel">Deletar personagem?</h1>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <h5> Um personagem deletado não pode ser restaurado! </h5>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#Characters">Cancelar</button>
                                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" @onclick="(() => DeleteCharacter(IdForDelete))">Confirmar</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Sem uso atualmente -->
                    <div class="row">

                    </div>

                </section>

            </div>
            
        }
        else{Navigation.NavigateTo("/Login");}
    </body>
</html>

@code
{
    // Salva todos os dados das tabelas do banco em listas ----------------------------------------------------------------------------
    public List<User>? users { get; set; } = new List<User>();
    public List<Campaign>? campaigns { get; set; } = new List<Campaign>();
    public List<Character>? characters { get; set; } = new List<Character>();
    public List<Skill>? skills { get; set; } = new List<Skill>();
    public List<Item>? itens { get; set; } = new List<Item>();

    protected override async Task OnInitializedAsync()
    {
        users = await Http.GetFromJsonAsync<List<User>?>("user");
        campaigns = await Http.GetFromJsonAsync<List<Campaign>?>("campaign");
        characters = await Http.GetFromJsonAsync<List<Character>?>("character");
        skills = await Http.GetFromJsonAsync<List<Skill>?>("skill");
        itens = await Http.GetFromJsonAsync<List<Item>?>("item");
    }

    // Recebe o ID do usuário e devolve seu nome --------------------------------------------------------------------------------------
    public string? username;
    public string IdForUserName(int Id)
    {
        foreach(var _user in users)
        {
            if(Id == _user.Id)
            {
                username = _user.Username;
            }
        }

        return(username);
    }

    // Recebe o ID da campanha e devolve seu nome -------------------------------------------------------------------------------------
    public string? campaignname;
    public string IdForCampaignName(int? Id)
    {
        foreach(var _campaign in campaigns)
        {
            if(Id == _campaign.Id)
            {
                campaignname = _campaign.Name;
            }
        }

        return(campaignname);

    }

    // Funções para realizar a operação de Delete -------------------------------------------------------------------------------------
    public int IdForDelete;

    public void SaveIdForDelete(int id)
    {
        IdForDelete = id;
    }
    
    public void DeleteCharacter(int id)
    {
        Http.DeleteFromJsonAsync<int>($"character/{id}");
        Navigation.NavigateTo("/");
    }

    public void DeleteCampaign(int id)
    {
        Http.DeleteFromJsonAsync<int>($"campaign/{id}");
        Navigation.NavigateTo("/");
    }
}